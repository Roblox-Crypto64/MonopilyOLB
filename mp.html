<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Monopoly — Final Multiplayer (ntfy.sh) — Fixed Buttons</title>

<!-- 100% privacy-first analytics -->
<script data-collect-dnt="true" async src="https://scripts.simpleanalyticscdn.com/latest.js"></script>
<noscript>
  <img src="https://queue.simpleanalyticscdn.com/noscript.gif?collect-dnt=true"
       alt="" referrerpolicy="no-referrer-when-downgrade"/>
</noscript>

<style>
/* ===========================================================
   Monopoly — Single-file final prototype
   - Center / Player modes
   - ntfy.sh publish/subscribe (SSE + POST)
   - Robust parsing of ntfy envelopes
   - Join accept/deny modal with center controls visible only while handling joins
   - Player devices do NOT show board (only controls)
   - Modal overlay no longer blocks clicks when hidden; center overlay clickable only when shown
   - Smooth animations and UX fixes for button clickability
   =========================================================== */

:root{
  --bg1:#071028;
  --bg2:#081a2a;
  --panel:#0b1720;
  --card-bg:linear-gradient(180deg,#0f1b26,#07101a);
  --accent:#ffd662;
  --muted:#9fb3c6;
  --tile-gap:6px;
  --tile-radius:8px;
  --board-size:min(92vmin,920px);
}

*{box-sizing:border-box}
html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg1),var(--bg2));font-family:Inter,system-ui,Segoe UI,Roboto,Arial;color:#eef;-webkit-font-smoothing:antialiased}
a{color:var(--accent)}

.container{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:18px}

/* chooser */
.chooser{display:flex;flex-direction:column;gap:18px;align-items:center}
.mode-select{display:flex;gap:12px}
.mode-btn{padding:12px 20px;border-radius:12px;border:none;background:linear-gradient(180deg,#1a6cff,#1560d6);color:white;font-weight:800;font-size:18px;box-shadow:0 12px 40px rgba(0,0,0,0.45);cursor:pointer}
.hint{max-width:900px;color:var(--muted);text-align:center}

/* main layout */
.app{display:flex;gap:12px;align-items:flex-start;justify-content:center;flex-wrap:wrap}
.board-outer{width:var(--board-size);height:var(--board-size);border-radius:14px;background:linear-gradient(180deg,#07121a,#041822);box-shadow:0 30px 120px rgba(0,0,0,0.6);position:relative;overflow:hidden}
.board{width:100%;height:100%;display:grid;grid-template-columns:repeat(11,1fr);grid-template-rows:repeat(11,1fr);gap:var(--tile-gap);padding:var(--tile-gap)}
.tile{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:var(--tile-radius);padding:8px;display:flex;flex-direction:column;justify-content:space-between;border:1px solid rgba(255,255,255,0.02);min-height:40px;transition:transform 220ms, box-shadow 220ms}
.tile:hover{transform:translateY(-6px);box-shadow:0 18px 60px rgba(0,0,0,0.5)}
.tile.corner{display:flex;align-items:center;justify-content:center;font-weight:800}
.color-bar{height:14px;border-radius:8px;margin-bottom:8px}
.title{font-weight:700;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.info-bar{display:flex;align-items:center;justify-content:space-between;gap:8px;background:rgba(0,0,0,0.04);padding:6px;border-radius:8px;font-size:12px}
.builds{position:absolute;right:8px;bottom:8px;display:flex;gap:6px}
.house{width:10px;height:10px;background:#0a8f2a;border-radius:2px;border:1px solid #053}
.hotel{width:14px;height:10px;background:#c02b2b;border-radius:2px;border:1px solid #700}

/* tokens */
.token{width:26px;height:26px;border-radius:50%;position:absolute;transform:translate(-50%,-50%);display:flex;align-items:center;justify-content:center;font-size:12px;color:#08121a;border:2px solid rgba(255,255,255,0.8);box-shadow:0 8px 28px rgba(0,0,0,0.5);z-index:90}

/* center overlay (dice & bank) — not visible by default, pointer only when visible */
.center-overlay{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);z-index:60;display:flex;flex-direction:column;align-items:center;gap:12px;pointer-events:none}
.center-card{pointer-events:auto;background:linear-gradient(180deg,#07161b,#051018);padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);display:flex;flex-direction:column;align-items:center;gap:10px;min-width:260px;opacity:0;transform:translateY(8px);transition:opacity 220ms, transform 220ms}
.center-card.visible{opacity:1;transform:translateY(0)}
.bank{font-weight:800;color:var(--accent)}
.dice{width:120px;height:120px;border-radius:14px;background:#fff;color:#111;display:flex;align-items:center;justify-content:center;font-size:48px;box-shadow:0 12px 40px rgba(0,0,0,0.5)}
.dice.rolling{animation:roll 700ms linear}
@keyframes roll{from{transform:rotate(0)}to{transform:rotate(360deg)}}

/* side */
.side{width:360px;min-width:260px;background:var(--card-bg);border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:12px;box-shadow:0 30px 80px rgba(0,0,0,0.6)}
.header{display:flex;align-items:center;justify-content:space-between}
.controls{display:flex;gap:8px;flex-wrap:wrap}
.btn{padding:10px 14px;border-radius:10px;border:none;background:linear-gradient(180deg,#1a6cff,#1560d6);color:white;font-weight:700;cursor:pointer}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06)}
.small{padding:8px 10px}
.input{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:#07121a;color:#dff}

/* logs & modal */
.log{background:linear-gradient(180deg,#04121a,#021018);padding:8px;border-radius:8px;max-height:260px;overflow:auto}
.modal-overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:120;pointer-events:none;background:rgba(0,0,0,0.5)}
.modal-overlay.show{display:flex;pointer-events:auto}
.modal{background:linear-gradient(180deg,#0f1b26,#07101a);padding:16px;border-radius:12px;color:#eef;min-width:320px;max-width:94vw;box-shadow:0 20px 80px rgba(0,0,0,0.6);transform:translateY(8px);animation:modalIn 180ms ease-out}
@keyframes modalIn{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}

/* notice */
.notice{position:absolute;top:18px;left:50%;transform:translateX(-50%);z-index:100;background:linear-gradient(90deg,#0b2940,#053246);padding:10px 16px;border-radius:10px;color:#dff;box-shadow:0 12px 40px rgba(0,0,0,0.6);opacity:0;transition:opacity 250ms, transform 250ms}
.notice.show{opacity:1;transform:translateX(-50%) translateY(0)}

/* small helpers */
.fade-out{animation:fadeOut 260ms forwards}
@keyframes fadeOut{to{opacity:0;transform:scale(.98)}}
.fade-in{animation:fadeIn 260ms forwards}
@keyframes fadeIn{from{opacity:0;transform:scale(.98)}to{opacity:1;transform:scale(1)}}

/* responsive */
@media(max-width:980px){
  .app{flex-direction:column;align-items:center}
  .side{width:92vw}
  .board-outer{width:92vw;height:92vw}
  .center-card{min-width:200px}
}
</style>
</head>
<body>

<!-- chooser -->
<div id="chooser" class="container chooser">
  <div style="text-align:center">
    <h1 style="margin:0">Monopoly — Multiplayer</h1>
    <div style="margin-top:8px;color:var(--muted)">Choose a mode: Center (host) or Player (controller)</div>
  </div>

  <div class="mode-select">
    <button id="modeCenter" class="mode-btn">Center Screen</button>
    <button id="modePlayer" class="mode-btn">Player Device</button>
  </div>

  <div class="hint">The center shows a 5-character code. Players enter that code on their device to join. Topic format: <code>Monopoly6y726346&lt;code&gt;</code></div>
</div>

<!-- main app -->
<div id="mainApp" class="container app" style="display:none">

  <!-- board -->
  <div class="board-outer" id="boardOuter">
    <div id="board" class="board" role="application" aria-label="Monopoly board 11x11"></div>

    <!-- center overlay -->
    <div class="center-overlay" id="centerOverlay">
      <div class="center-card" id="centerCard" aria-hidden="true">
        <div class="bank" id="centerBank">Bank: £0</div>
        <div class="dice" id="dice">—</div>
        <div style="display:flex;gap:8px">
          <button id="centerRoll" class="btn small">Roll</button>
          <button id="startGame" class="btn ghost small">Go (start)</button>
        </div>
      </div>
    </div>

    <div id="notice" class="notice" style="display:none"></div>
  </div>

  <!-- side panel -->
  <div class="side">

    <div class="header">
      <div id="sideTitle"><strong>Center</strong></div>
      <div id="sideTopActions"></div>
    </div>

    <!-- Center UI -->
    <div id="centerUI" style="display:none">
      <div style="display:flex;gap:8px;align-items:center">
        <label style="font-weight:700">Game code:</label>
        <div id="gameCode" style="font-weight:800;color:var(--accent);font-size:18px">—</div>
      </div>

      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="subscribeBtn" class="btn small">Start listening</button>
        <button id="unsubscribeBtn" class="btn ghost small" disabled>Stop</button>
      </div>

      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="lockJoinsBtn" class="btn">Lock joins</button>
        <button id="unlockJoinsBtn" class="btn ghost" disabled>Unlock joins</button>
      </div>

      <h4 style="margin-top:12px">Players</h4>
      <div id="playersList" style="max-height:140px;overflow:auto"></div>

      <h4 style="margin-top:12px">Log</h4>
      <div id="centerLog" class="log"></div>
    </div>

    <!-- Player UI -->
    <div id="playerUI" style="display:none">
      <h3>Player</h3>
      <input id="playerCode" class="input" placeholder="Game code (5 chars)" />
      <input id="playerName" class="input" placeholder="Your name" style="margin-top:8px" />
      <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
        <label style="display:flex;align-items:center;gap:8px"><input id="playerReqAdmin" type="checkbox"> Request Admin</label>
        <button id="playerJoinBtn" class="btn">Join</button>
      </div>

      <div id="playerControls" style="display:none;margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center"><div id="playerLabel">You</div><button id="playerLeaveBtn" class="btn ghost small">Leave</button></div>
        <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
          <button id="playerRollBtn" class="btn small">Roll (if your turn)</button>
          <button id="playerBuyBtn" class="btn small">Buy (if on tile)</button>
          <button id="playerEndBtn" class="btn small">End Turn</button>
          <button id="playerMyCardsBtn" class="btn small ghost">My Cards</button>
        </div>
        <h4 style="margin-top:12px">Messages</h4>
        <div id="playerLog" class="log"></div>
      </div>
    </div>

    <!-- Admin UI -->
    <div id="adminUI" style="display:none">
      <h3>Admin</h3>
      <div style="display:flex;gap:8px">
        <select id="adminPlayerSelect" class="input"></select>
        <input id="adminAmount" class="input" type="number" value="100" />
      </div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="adminGive" class="btn">Give</button>
        <button id="adminTake" class="btn ghost">Take</button>
        <button id="adminKick" class="btn ghost">Kick</button>
      </div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="adminMsg" class="btn">Broadcast Message</button>
        <button id="adminSetPin" class="btn ghost">Set PIN</button>
      </div>
      <h4 style="margin-top:12px">Admin Log</h4>
      <div id="adminLog" class="log"></div>
    </div>

  </div>
</div>

<!-- modal -->
<div id="modalOverlay" class="modal-overlay">
  <div id="modalInner" class="modal"></div>
</div>

<script>
/* ===========================================================
   Full in-browser prototype script
   - Handles UI, board, player/center flows
   - ntfy.sh publish/subscribe integration (SSE + POST)
   - Robust parsing for ntfy envelopes
   - Fixes for non-clickable buttons via pointer-events and z-index
   =========================================================== */

/* ---------- Utilities ---------- */

const PREFIX = "Monopoly6y726346";
const ALPHANUM = "abcdefghijklmnopqrstuvwxyz0123456789";
function randCode(len=5){ let s=''; for(let i=0;i<len;i++) s += ALPHANUM[Math.floor(Math.random()*ALPHANUM.length)]; return s; }
function el(tag,cls,txt){ const e=document.createElement(tag); if(cls) e.className = cls; if(txt!==undefined) e.textContent = txt; return e; }
function parseEnvelope(raw){
  if(!raw) return null;
  // If already an object with type, return it
  if(typeof raw === 'object' && raw.type) return raw;
  // If envelope object with `message` string field, try parse that
  if(typeof raw === 'object' && raw.message){
    try{ return JSON.parse(raw.message); }catch(e){}
  }
  // If string, try parse
  if(typeof raw === 'string'){
    try{ return JSON.parse(raw); }catch(e){}
  }
  return null;
}
function showNotice(text, duration=5000){
  const n = document.getElementById('notice');
  n.textContent = text;
  n.style.display = 'block';
  n.classList.add('show');
  setTimeout(()=>{ n.classList.remove('show'); setTimeout(()=> n.style.display='none', 300); }, duration);
}
function openModal(node){
  const overlay = document.getElementById('modalOverlay');
  const inner = document.getElementById('modalInner');
  inner.innerHTML = '';
  inner.appendChild(node);
  overlay.classList.add('show');
}
function closeModal(){ document.getElementById('modalOverlay').classList.remove('show'); document.getElementById('modalInner').innerHTML = ''; }

/* ---------- Board data ---------- */

const BOARD_TEMPLATE = (function(){
  return [
    { name:"GO", type:"corner", label:"GO" },
    { name:"Old Kent Road", type:"property", color:"brown", price:60, rent:[2,10,30,90,160,250], houseCost:50, mortgage:30 },
    { name:"Community Chest", type:"chest" },
    { name:"Whitechapel Road", type:"property", color:"brown", price:60, rent:[4,20,60,180,320,450], houseCost:50, mortgage:30 },
    { name:"Income Tax", type:"tax", amount:200 },
    { name:"Kings Cross Station", type:"railway", price:200, mortgage:100 },
    { name:"The Angel Islington", type:"property", color:"lightblue", price:100, rent:[6,30,90,270,400,550], houseCost:50, mortgage:50 },
    { name:"Chance", type:"chance" },
    { name:"Euston Road", type:"property", color:"lightblue", price:100, rent:[6,30,90,270,400,550], houseCost:50, mortgage:50 },
    { name:"Pentonville Road", type:"property", color:"lightblue", price:120, rent:[8,40,100,300,450,600], houseCost:50, mortgage:60 },
    { name:"Jail / Just Visiting", type:"corner", label:"Jail" },
    { name:"Pall Mall", type:"property", color:"pink", price:140, rent:[10,50,150,450,625,750], houseCost:100, mortgage:70 },
    { name:"Electric Company", type:"utility", price:150, mortgage:75 },
    { name:"Whitehall", type:"property", color:"pink", price:140, rent:[10,50,150,450,625,750], houseCost:100, mortgage:70 },
    { name:"Northumberland Avenue", type:"property", color:"pink", price:160, rent:[12,60,180,500,700,900], houseCost:100, mortgage:80 },
    { name:"Marylebone Station", type:"railway", price:200, mortgage:100 },
    { name:"Bow Street", type:"property", color:"orange", price:180, rent:[14,70,200,550,750,950], houseCost:100, mortgage:90 },
    { name:"Community Chest", type:"chest" },
    { name:"Marlborough Street", type:"property", color:"orange", price:180, rent:[14,70,200,550,750,950], houseCost:100, mortgage:90 },
    { name:"Vine Street", type:"property", color:"orange", price:200, rent:[16,80,220,600,800,1000], houseCost:100, mortgage:100 },
    { name:"Free Parking", type:"corner", label:"Free Parking" },
    { name:"Strand", type:"property", color:"red", price:220, rent:[18,90,250,700,875,1050], houseCost:150, mortgage:110 },
    { name:"Chance", type:"chance" },
    { name:"Fleet Street", type:"property", color:"red", price:220, rent:[18,90,250,700,875,1050], houseCost:150, mortgage:110 },
    { name:"Trafalgar Square", type:"property", color:"red", price:240, rent:[20,100,300,750,925,1100], houseCost:150, mortgage:120 },
    { name:"Fenchurch St Station", type:"railway", price:200, mortgage:100 },
    { name:"Leicester Square", type:"property", color:"yellow", price:260, rent:[22,110,330,800,975,1150], houseCost:150, mortgage:130 },
    { name:"Coventry Street", type:"property", color:"yellow", price:260, rent:[22,110,330,800,975,1150], houseCost:150, mortgage:130 },
    { name:"Water Works", type:"utility", price:150, mortgage:75 },
    { name:"Piccadilly", type:"property", color:"yellow", price:280, rent:[24,120,360,850,1025,1200], houseCost:150, mortgage:140 },
    { name:"Go To Jail", type:"corner", label:"Go To Jail" },
    { name:"Regent Street", type:"property", color:"green", price:300, rent:[26,130,390,900,1100,1275], houseCost:200, mortgage:150 },
    { name:"Oxford Street", type:"property", color:"green", price:300, rent:[26,130,390,900,1100,1275], houseCost:200, mortgage:150 },
    { name:"Community Chest", type:"chest" },
    { name:"Bond Street", type:"property", color:"green", price:320, rent:[28,150,450,1000,1200,1400], houseCost:200, mortgage:160 },
    { name:"Liverpool St Station", type:"railway", price:200, mortgage:100 },
    { name:"Chance", type:"chance" },
    { name:"Park Lane", type:"property", color:"darkblue", price:350, rent:[35,175,500,1100,1300,1500], houseCost:200, mortgage:175 },
    { name:"Super Tax", type:"tax", amount:100 },
    { name:"Mayfair", type:"property", color:"darkblue", price:400, rent:[50,200,600,1400,1700,2000], houseCost:200, mortgage:200 }
  ];
})();

let Board = JSON.parse(JSON.stringify(BOARD_TEMPLATE));
Board.forEach(b => { b.owner = undefined; b.ownerName = undefined; b.mortgaged = b.mortgaged || false; });

const colorToHex = { brown:"#8b4b2e", lightblue:"#7fc8ff", pink:"#ff7ecb", orange:"#ffb36b", red:"#df5a5a", yellow:"#ffde59", green:"#4db86b", darkblue:"#2b5cff" };

/* ---------- App state ---------- */

let mode = null; // 'center' or 'player'
let centerTopic = null;
let centerSSE = null;
let subscribing = false;
let joinsLocked = false;
let centerPlayers = []; // { clientId, assignedId, name, money, position, houses:{}, isAdmin, pin, properties:[] }
let centerByClient = {}; // map clientId -> player
let currentTurn = 0;

let localClient = null; // for player devices: { clientId, name, topic, assignedId, isAdmin, es, state }

/* ---------- DOM refs ---------- */

const chooser = document.getElementById('chooser');
const mainApp = document.getElementById('mainApp');

const btnModeCenter = document.getElementById('modeCenter');
const btnModePlayer = document.getElementById('modePlayer');

const boardEl = document.getElementById('board');
const boardOuter = document.getElementById('boardOuter');
const centerCard = document.getElementById('centerCard');
const centerBankEl = document.getElementById('centerBank');
const diceEl = document.getElementById('dice');
const centerRollBtn = document.getElementById('centerRoll');
const startGameBtn = document.getElementById('startGame');

const centerUI = document.getElementById('centerUI');
const playerUI = document.getElementById('playerUI');
const adminUI = document.getElementById('adminUI');

const gameCodeEl = document.getElementById('gameCode');
const subscribeBtn = document.getElementById('subscribeBtn');
const unsubscribeBtn = document.getElementById('unsubscribeBtn');
const lockJoinsBtn = document.getElementById('lockJoinsBtn');
const unlockJoinsBtn = document.getElementById('unlockJoinsBtn');
const playersListDiv = document.getElementById('playersList');
const centerLogDiv = document.getElementById('centerLog');

const playerCodeInput = document.getElementById('playerCode');
const playerNameInput = document.getElementById('playerName');
const playerReqAdmin = document.getElementById('playerReqAdmin');
const playerJoinBtn = document.getElementById('playerJoinBtn');

const playerControlsDiv = document.getElementById('playerControls');
const playerLabelDiv = document.getElementById('playerLabel');
const playerLogDiv = document.getElementById('playerLog');

const playerRollBtn = document.getElementById('playerRollBtn');
const playerBuyBtn = document.getElementById('playerBuyBtn');
const playerEndBtn = document.getElementById('playerEndBtn');
const playerMyCardsBtn = document.getElementById('playerMyCardsBtn');

const modalOverlay = document.getElementById('modalOverlay');
const modalInner = document.getElementById('modalInner');
const notice = document.getElementById('notice');

/* ---------- Board rendering ---------- */

function gridMapping(){
  const coords = [];
  for(let col=11;col>=1;col--) coords.push({row:11,col});
  for(let row=10;row>=1;row--) coords.push({row,col:1});
  for(let col=2;col<=11;col++) coords.push({row:1,col});
  for(let row=2;row<=10;row++) coords.push({row,col:11});
  return coords.slice(0,40).map((p,i)=>({index:i,row:p.row,col:p.col}));
}

function renderBoard(){
  boardEl.innerHTML = '';
  const map = gridMapping();
  for(let r=1;r<=11;r++){
    for(let c=1;c<=11;c++){
      const cell = el('div','tile');
      cell.style.gridRow = r; cell.style.gridColumn = c;
      const pos = map.find(m=>m.row===r && m.col===c);
      if(pos){
        const idx = pos.index;
        const t = Board[idx];
        cell.dataset.index = idx;
        if(t.type === 'corner'){
          cell.classList.add('corner');
          cell.innerHTML = `<div class="title">${t.label || t.name}</div>`;
        } else {
          const color = t.color ? colorToHex[t.color] : '#222';
          cell.innerHTML = `<div class="color-bar" style="background:${color}"></div>
            <div class="title" title="${t.name}">${t.name}</div>
            <div class="info-bar"><div class="name-small">${t.name}</div><div class="owner" data-owner="${idx}">Owner: —</div></div>
            <div class="builds"></div>`;
        }
        // only center mode shows spec card on click
        cell.addEventListener('click', ()=> { if(mode === 'center') showSpecCard(idx); });
      } else {
        cell.style.background = 'transparent';
      }
      boardEl.appendChild(cell);
    }
  }
  updateBoardLabels();
}

/* update owner labels and builds */
function updateBoardLabels(){
  document.querySelectorAll('[data-owner]').forEach(el=>{
    const idx = Number(el.getAttribute('data-owner'));
    const t = Board[idx];
    el.textContent = t.owner !== undefined ? `Owner: ${t.ownerName || '(player)'}` : 'Owner: (bank)';
  });

  document.querySelectorAll('.tile').forEach(tile=>{
    const idx = Number(tile.dataset.index);
    if(isNaN(idx)) return;
    const builds = tile.querySelector('.builds');
    builds.innerHTML = '';
    const t = Board[idx];
    if(t.owner !== undefined){
      const owner = centerPlayers.find(p=>p.assignedId === t.owner);
      const cnt = owner && owner.houses && owner.houses[idx] || 0;
      if(cnt>=1 && cnt<=4) for(let i=0;i<cnt;i++) builds.appendChild(el('div','house'));
      else if(cnt>=5) builds.appendChild(el('div','hotel'));
    }
  });
}

/* ---------- Modal helpers ---------- */
function showModal(node){
  modalInner.innerHTML = ''; modalInner.appendChild(node); modalOverlay.classList.add('show');
}
function hideModal(){ modalOverlay.classList.remove('show'); modalInner.innerHTML = ''; }

/* ---------- Center controls visibility (important fix) ---------- */
function setCenterControlsVisible(show){
  if(show){
    centerCard.classList.add('visible');
    centerCard.setAttribute('aria-hidden','false');
    // also enable pointer events for overlay container
    document.getElementById('centerOverlay').style.pointerEvents = 'auto';
  } else {
    centerCard.classList.remove('visible');
    centerCard.setAttribute('aria-hidden','true');
    document.getElementById('centerOverlay').style.pointerEvents = 'none';
  }
}

/* hide center controls by default (board primary) */
setTimeout(()=> setCenterControlsVisible(false), 50);

/* ---------- ntfy publish/subscribe helpers ---------- */

async function publishTopic(topic, payload){
  try{
    await fetch(`https://ntfy.sh/${encodeURIComponent(topic)}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
  }catch(e){
    console.error('publishTopic error', e);
  }
}

function subscribeTopic(topic, onMessage, onError){
  const url1 = `https://ntfy.sh/${encodeURIComponent(topic)}/sse`;
  try{
    const es = new EventSource(url1);
    es.onmessage = ev => {
      let data = null;
      try{ data = JSON.parse(ev.data); }catch(e){ data = ev.data; }
      const parsed = parseEnvelope(data);
      onMessage(parsed || data);
    };
    es.onerror = err => { if(onError) onError(err); };
    return es;
  }catch(e){
    const url2 = `https://ntfy.sh/subscribe/${encodeURIComponent(topic)}?format=sse`;
    try{
      const es = new EventSource(url2);
      es.onmessage = ev => {
        let data = null;
        try{ data = JSON.parse(ev.data); }catch(e){ data = ev.data; }
        const parsed = parseEnvelope(data);
        onMessage(parsed || data);
      };
      es.onerror = err => { if(onError) onError(err); };
      return es;
    }catch(e2){
      if(onError) onError(e2);
      return null;
    }
  }
}

/* ---------- Center message handling (joinRequest etc.) ---------- */

function onCenterSubscribeMessage(raw){
  const parsed = parseEnvelope(raw);
  if(!parsed){
    logCenter('Received unknown message: ' + JSON.stringify(raw));
    return;
  }
  // route
  if(parsed.type === 'joinRequest'){
    handleJoinRequest(parsed);
    return;
  }
  if(parsed.type === 'command'){
    handleCommand(parsed);
    return;
  }
  // many other message types (rolled, bought, moved) may be ignored or logged by center itself
  logCenter('Unhandled center message: ' + JSON.stringify(parsed));
}

/* Accept/Deny join handling (center) */
function handleJoinRequest(req){
  // req = { type:'joinRequest', clientId, name, requestAdmin }
  if(!req || !req.clientId) return;
  logCenter(`Join request: ${req.name} (${req.clientId}) admin=${!!req.requestAdmin}`);
  // show center controls (so operator can act)
  setCenterControlsVisible(true);
  // show a modal with accept/deny
  const modal = el('div');
  modal.innerHTML = `<h3>${req.name} wants to join</h3><p>Client: ${req.clientId}</p><div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px"><button id="acceptBtn" class="btn">Accept</button><button id="denyBtn" class="btn ghost">Deny</button></div>`;
  showModal(modal);
  modal.querySelector('#acceptBtn').addEventListener('click', ()=>{
    acceptJoin(req);
    hideModal();
    // after accept, hide center controls again
    setTimeout(()=> setCenterControlsVisible(false), 500);
  });
  modal.querySelector('#denyBtn').addEventListener('click', ()=>{
    denyJoin(req);
    hideModal();
    setTimeout(()=> setCenterControlsVisible(false), 500);
  });
}

function acceptJoin(req){
  const assignedId = centerPlayers.length;
  const p = { clientId: req.clientId, assignedId, name: req.name, money:1500, position:0, houses:{}, isAdmin: !!req.requestAdmin, pin:'', properties:[] };
  centerPlayers.push(p); centerByClient[req.clientId] = p;
  logCenter(`Accepted join: ${req.name} -> id ${assignedId}`);
  // send joinAccepted notification with initial state
  publishTopic(centerTopic, { type:'joinAccepted', clientId: req.clientId, assignedId, name: req.name, isAdmin: p.isAdmin, initialState: { money:p.money, position:p.position, properties:p.properties }});
  updatePlayersList();
  showNotice(`${p.name} joined`, 5000);
}

function denyJoin(req){
  publishTopic(centerTopic, { type:'joinDenied', clientId: req.clientId, reason: 'denied by center' });
  logCenter(`Denied join: ${req.name}`);
}

/* ---------- Handle player commands at center ---------- */

function handleCommand(cmd){
  // cmd: { type:'command', clientId, action, payload }
  if(!cmd || !cmd.clientId || !cmd.action) return;
  const player = centerByClient[cmd.clientId];
  if(!player){ logCenter('Command from unknown client: ' + cmd.clientId); publishTopic(centerTopic, { type:'commandDenied', clientId: cmd.clientId, reason:'unknown client' }); return; }
  if(cmd.action === 'requestRoll' || cmd.action === 'roll'){
    // allow if it's player's turn
    if(centerPlayers.length === 0){ publishTopic(centerTopic, { type:'denied', clientId: cmd.clientId, reason:'no players yet' }); return; }
    if(centerPlayers[currentTurn].clientId !== cmd.clientId){ publishTopic(centerTopic, { type:'denied', clientId: cmd.clientId, reason:'not your turn' }); return; }
    const r1 = 1 + Math.floor(Math.random()*6), r2 = 1 + Math.floor(Math.random()*6);
    logCenter(`${player.name} rolled ${r1} & ${r2}`);
    showNotice(`${player.name} rolled ${r1} & ${r2}`, 5000);
    animateDice(r1 + r2, ()=>{
      player.position = (player.position + r1 + r2) % 40;
      publishTopic(centerTopic, { type:'rolled', clientId: player.clientId, assignedId: player.assignedId, r1, r2 });
      publishTopic(centerTopic, { type:'moved', clientId: player.clientId, assignedId: player.assignedId, newPos: player.position });
      updatePlayersList(); updateBoard();
    });
    return;
  }
  if(cmd.action === 'requestBuy' || cmd.action === 'buy'){
    const tileIdx = Number(cmd.payload && cmd.payload.tileIdx);
    if(isNaN(tileIdx)){ publishTopic(centerTopic, { type:'denied', clientId: cmd.clientId, reason:'invalid tile' }); return; }
    if(player.position !== tileIdx){ publishTopic(centerTopic, { type:'denied', clientId: cmd.clientId, reason:'not on tile' }); return; }
    const tile = Board[tileIdx];
    if(tile.owner !== undefined){ publishTopic(centerTopic, { type:'denied', clientId: cmd.clientId, reason:'already owned' }); return; }
    if(player.money < (tile.price || 0)){ publishTopic(centerTopic, { type:'denied', clientId: cmd.clientId, reason:'insufficient funds' }); return; }
    player.money -= tile.price || 0;
    tile.owner = player.assignedId; tile.ownerName = player.name;
    player.properties.push(tileIdx);
    logCenter(`${player.name} bought ${tile.name} for £${tile.price}`);
    showNotice(`${player.name} bought ${tile.name}`, 5000);
    publishTopic(centerTopic, { type:'bought', clientId: player.clientId, assignedId: player.assignedId, tileIdx, price: tile.price });
    updatePlayersList(); updateBoard();
    return;
  }
  if(cmd.action === 'endTurn'){
    if(centerPlayers.length === 0) return;
    if(centerPlayers[currentTurn].clientId !== cmd.clientId){ publishTopic(centerTopic, { type:'denied', clientId: cmd.clientId, reason:'not your turn' }); return; }
    logCenter(`${player.name} ended turn`);
    showNotice(`${player.name} ended turn`, 4000);
    currentTurn = (currentTurn + 1) % centerPlayers.length;
    publishTopic(centerTopic, { type:'turnAdvanced', currentTurn });
    return;
  }
  if(cmd.action === 'sellToBank'){
    const tileIdx = Number(cmd.payload && cmd.payload.tileIdx);
    if(isNaN(tileIdx)){ publishTopic(centerTopic, { type:'denied', clientId: cmd.clientId, reason:'invalid tile' }); return; }
    const tile = Board[tileIdx];
    if(tile.owner !== player.assignedId){ publishTopic(centerTopic, { type:'denied', clientId: cmd.clientId, reason:'not owner' }); return; }
    const value = Math.floor((tile.price || 0) / 2);
    player.money += value;
    player.properties = (player.properties || []).filter(i => i !== tileIdx);
    tile.owner = undefined; tile.ownerName = undefined; tile.mortgaged = false;
    logCenter(`${player.name} sold ${tile.name} to bank for £${value}`);
    publishTopic(centerTopic, { type:'soldToBank', clientId: player.clientId, tileIdx, price:value });
    updatePlayersList(); updateBoard();
    return;
  }
  if(cmd.action === 'toggleMortgage'){
    const tileIdx = Number(cmd.payload && cmd.payload.tileIdx);
    if(isNaN(tileIdx)){ publishTopic(centerTopic, { type:'denied', clientId: cmd.clientId, reason:'invalid tile' }); return; }
    const tile = Board[tileIdx];
    if(tile.owner !== player.assignedId){ publishTopic(centerTopic, { type:'denied', clientId: cmd.clientId, reason:'not owner' }); return; }
    if(tile.mortgaged){
      const cost = Math.ceil((tile.mortgage || Math.floor((tile.price||0)/2)) * 1.1);
      if(player.money < cost){ publishTopic(centerTopic, { type:'denied', clientId: cmd.clientId, reason:'insufficient funds to unmortgage' }); return; }
      player.money -= cost; tile.mortgaged = false;
      logCenter(`${player.name} unmortgaged ${tile.name} for £${cost}`);
      publishTopic(centerTopic, { type:'unmortgaged', clientId: player.clientId, tileIdx, cost });
    } else {
      // sell houses across set if necessary (simplified)
      const set = Board.map((b,i)=>({b,i})).filter(x=>x.b.type==='property' && x.b.color === tile.color).map(x=>x.i);
      let refund = 0;
      set.forEach(i => {
        const cnt = (player.houses && player.houses[i]) || 0;
        if(cnt>0){
          const hc = Board[i].houseCost || tile.houseCost || 0;
          const r = (cnt>=5) ? Math.floor(hc/2)*5 : Math.floor(hc/2)*cnt;
          refund += r;
          delete player.houses[i];
        }
      });
      if(refund>0) player.money += refund;
      const val = tile.mortgage || Math.floor((tile.price||0)/2);
      tile.mortgaged = true; player.money += val;
      logCenter(`${player.name} mortgaged ${tile.name} for £${val} (refunded £${refund} from houses)`);
      publishTopic(centerTopic, { type:'mortgaged', clientId: player.clientId, tileIdx, value: val, refunded: refund });
    }
    updatePlayersList(); updateBoard();
    return;
  }

  logCenter('Unknown command: ' + JSON.stringify(cmd));
}

/* ---------- Center publish/subscribe wiring ---------- */

document.getElementById('subscribeBtn').addEventListener('click', ()=> {
  if(!centerTopic) return alert('No topic — start Center mode first');
  if(centerSSE) return alert('Already subscribed');
  centerSSE = subscribeTopic(centerTopic, onCenterSubscribeMessage, (err)=> logCenter('SSE error: ' + (err?String(err):'unknown')));
  if(centerSSE){
    subscribing = true;
    document.getElementById('subscribeBtn').disabled = true;
    document.getElementById('unsubscribeBtn').disabled = false;
    logCenter('Subscribed to ' + centerTopic);
    showNotice('Subscribed to ntfy topic', 3000);
  } else {
    alert('Failed to subscribe to ntfy SSE — check network/CORS or try again');
  }
});

document.getElementById('unsubscribeBtn').addEventListener('click', ()=> {
  if(centerSSE){ centerSSE.close(); centerSSE = null; subscribing = false; document.getElementById('subscribeBtn').disabled = false; document.getElementById('unsubscribeBtn').disabled = true; logCenter('Unsubscribed'); }
});

/* lock/unlock joins UI */
document.getElementById('lockJoinsBtn').addEventListener('click', ()=> {
  joinsLocked = true;
  document.getElementById('lockJoinsBtn').disabled = true;
  document.getElementById('unlockJoinsBtn').disabled = false;
  logCenter('Joins locked');
  showNotice('Joins locked', 3000);
});
document.getElementById('unlockJoinsBtn').addEventListener('click', ()=> {
  joinsLocked = false;
  document.getElementById('lockJoinsBtn').disabled = false;
  document.getElementById('unlockJoinsBtn').disabled = true;
  logCenter('Joins unlocked');
  showNotice('Joins unlocked', 3000);
});

/* ---------- Center accept/deny: helper to ensure main buttons not blocked ---------- */
/* setCenterControlsVisible already defined earlier (CSS + function). Ensure centerCard hidden by default. */
setCenterControlsVisible(false);

/* ---------- Player side: join and subscribe ---------- */

document.getElementById('playerJoinBtn').addEventListener('click', async ()=> {
  const code = (playerCodeInput.value || '').trim().toLowerCase();
  const name = (playerNameInput.value || '').trim() || ('Player' + Math.floor(Math.random()*1000));
  const wantAdmin = !!playerReqAdmin.checked;
  if(!/^[a-z0-9]{5}$/.test(code)) return alert('Enter a 5-character code: lowercase letters and digits only');
  const topic = PREFIX + code;
  const clientId = 'c_' + Math.random().toString(36).slice(2,9);
  localClient = { clientId, name, topic, assignedId: null, isAdmin:false, es:null, state: { money:0, position:0, properties: [] } };

  // subscribe to topic SSE
  localClient.es = subscribeTopic(topic, onPlayerSSEMessage, (err)=> logPlayer('SSE error: ' + (err?String(err):'unknown')));

  // publish join request
  try{
    await publishTopic(topic, { type:'joinRequest', clientId, name, requestAdmin: wantAdmin });
    logPlayer('Join request sent — waiting for acceptance');
    // Keep join UI visible until joinAccepted or joinDenied
  }catch(e){
    logPlayer('Failed to publish join request: ' + e.message);
  }
});

/* Player SSE handler */
function onPlayerSSEMessage(raw){
  const parsed = parseEnvelope(raw);
  if(!parsed){ logPlayer('Unknown SSE payload: ' + JSON.stringify(raw)); return; }
  const msg = parsed;
  if(msg.type === 'joinAccepted' && msg.clientId === localClient.clientId){
    localClient.assignedId = msg.assignedId; localClient.isAdmin = !!msg.isAdmin;
    localClient.state = msg.initialState || { money:1500, position:0, properties: [] };
    logPlayer('Join accepted! assignedId=' + localClient.assignedId);
    // hide join inputs with animation
    playerCodeInput.classList.add('fade-out');
    playerNameInput.classList.add('fade-out');
    playerReqAdmin.parentElement.classList.add('fade-out');
    playerJoinBtn.classList.add('fade-out');
    setTimeout(()=> {
      playerCodeInput.style.display = 'none';
      playerNameInput.style.display = 'none';
      playerReqAdmin.parentElement.style.display = 'none';
      playerJoinBtn.style.display = 'none';
      playerControlsDiv.style.display = 'block';
      playerLabelDiv.textContent = `${localClient.name} (id ${localClient.assignedId})`;
      showNotice(`${localClient.name} joined`, 4000);
    }, 320);
    return;
  }
  if(msg.type === 'joinDenied' && msg.clientId === localClient.clientId){
    logPlayer('Join denied: ' + (msg.reason || ''));
    return;
  }
  if(msg.type === 'rolled'){
    logPlayer(`Rolled: ${msg.r1} & ${msg.r2}`);
    animateDiceLocal(msg.r1 + msg.r2);
    return;
  }
  if(msg.type === 'moved'){
    if(localClient.assignedId === msg.assignedId){
      localClient.state.position = msg.newPos;
      logPlayer('You moved to ' + msg.newPos);
    } else {
      logPlayer(`Player ${msg.assignedId} moved to ${msg.newPos}`);
    }
    return;
  }
  if(msg.type === 'bought'){
    logPlayer(`Player ${msg.assignedId} bought ${msg.tileIdx} for £${msg.price}`);
    return;
  }
  if(msg.type === 'turnAdvanced'){
    logPlayer(`Turn advanced: ${msg.currentTurn}`);
    return;
  }
  logPlayer('IN: ' + JSON.stringify(msg));
}

/* Player buttons: publish commands */
document.getElementById('playerRollBtn').addEventListener('click', async ()=> {
  if(!localClient) return alert('Join first');
  await publishTopic(localClient.topic, { type:'command', clientId: localClient.clientId, action:'requestRoll' });
  logPlayer('Requested roll');
});
document.getElementById('playerBuyBtn').addEventListener('click', async ()=> {
  if(!localClient) return alert('Join first');
  const pos = localClient.state.position || 0;
  await publishTopic(localClient.topic, { type:'command', clientId: localClient.clientId, action:'requestBuy', payload:{ tileIdx: pos } });
  logPlayer('Requested buy on tile ' + pos);
});
document.getElementById('playerEndBtn').addEventListener('click', async ()=> {
  if(!localClient) return alert('Join first');
  await publishTopic(localClient.topic, { type:'command', clientId: localClient.clientId, action:'endTurn' });
  logPlayer('Requested end turn');
});
document.getElementById('playerMyCardsBtn').addEventListener('click', ()=> {
  if(!localClient) return alert('Join first');
  showMyCardsModal();
});

/* ---------- My Cards modal for player ---------- */
function showMyCardsModal(){
  if(!localClient) return;
  const card = el('div','card-size');
  card.innerHTML = `<h3>${localClient.name} — My Cards</h3><div><strong>Cash:</strong> £${localClient.state.money || 0}</div><div style="margin-top:8px"><h4>Properties</h4><div id="propsList" style="max-height:260px;overflow:auto"></div></div><div style="display:flex;justify-content:flex-end;margin-top:12px"><button id="closeCards" class="btn ghost">Close</button></div>`;
  openModal(card);
  const propsDiv = document.getElementById('propsList');
  if(!localClient.state.properties || localClient.state.properties.length === 0) propsDiv.innerHTML = '<p>No properties</p>';
  localClient.state.properties.forEach(idx => {
    const t = Board[idx];
    const row = el('div','prop-row');
    row.innerHTML = `<div style="flex:1"><strong>${t.name}</strong><div style="font-size:12px;color:var(--muted)">Mortgage: £${t.mortgage || Math.floor((t.price||0)/2)}</div></div>`;
    const sellBtn = el('button','btn small ghost'); sellBtn.textContent = 'Sell to Bank';
    const mortBtn = el('button','btn small'); mortBtn.textContent = t.mortgaged ? 'Unmortgage' : 'Mortgage';
    const actions = el('div'); actions.style.display='flex'; actions.style.flexDirection='column'; actions.style.gap='6px';
    actions.appendChild(sellBtn); actions.appendChild(mortBtn); row.appendChild(actions); propsDiv.appendChild(row);

    sellBtn.addEventListener('click', async ()=>{
      if(!confirm(`Sell ${t.name} to bank for £${Math.floor((t.price||0)/2)}?`)) return;
      await publishTopic(localClient.topic, { type:'command', clientId: localClient.clientId, action:'sellToBank', payload:{ tileIdx: idx } });
      logPlayer('Requested sell to bank');
      closeModal();
    });
    mortBtn.addEventListener('click', async ()=>{
      await publishTopic(localClient.topic, { type:'command', clientId: localClient.clientId, action:'toggleMortgage', payload:{ tileIdx: idx } });
      logPlayer('Requested mortgage toggle');
      closeModal();
    });
  });
  document.getElementById('closeCards').addEventListener('click', ()=> closeModal());
}

/* ---------- Helpers: render players list at center ---------- */
function updatePlayersList(){
  playersListDiv.innerHTML = '';
  centerPlayers.forEach(p => {
    const item = el('div');
    item.style.display = 'flex'; item.style.justifyContent = 'space-between'; item.style.padding = '6px'; item.style.borderBottom = '1px solid rgba(255,255,255,0.03)';
    item.innerHTML = `<div><strong>${p.name}</strong> ${p.isAdmin ? '<small style="color:var(--accent)">ADMIN</small>' : ''}<br><small style="color:var(--muted)">pos:${p.position} money:£${p.money}</small></div><div style="display:flex;flex-direction:column;gap:6px"><button class="btn small" data-client="${p.clientId}" data-act="move">Move</button><button class="btn ghost small" data-client="${p.clientId}" data-act="kick">Kick</button></div>`;
    playersListDiv.appendChild(item);
  });
  // wire buttons
  playersListDiv.querySelectorAll('button').forEach(btn => {
    btn.addEventListener('click', (ev)=>{
      const clientId = ev.target.getAttribute('data-client');
      const act = ev.target.getAttribute('data-act');
      const p = centerPlayers.find(x => x.clientId === clientId);
      if(!p) return;
      if(act === 'kick'){ centerPlayers = centerPlayers.filter(x => x.clientId !== clientId); delete centerByClient[clientId]; publishTopic(centerTopic, { type:'kicked', clientId, reason:'kicked by center' }); logCenter(`Kicked ${p.name}`); updatePlayersList(); updateBoard(); }
      if(act === 'move'){ const newPos = Number(prompt('Move player to tile index 0-39:', String(p.position))); if(isNaN(newPos)||newPos<0||newPos>39) return alert('Invalid'); p.position = newPos; publishTopic(centerTopic, { type:'forcedMove', clientId, newPos }); logCenter(`Moved ${p.name} to ${newPos}`); updatePlayersList(); updateBoard(); }
    });
  });
}

/* ---------- Dice animation (center & local) ---------- */

function animateDice(sum, cb){
  diceEl.classList.add('rolling');
  let flick = setInterval(()=> diceEl.textContent = String(1 + Math.floor(Math.random()*6)), 80);
  setTimeout(()=> { clearInterval(flick); diceEl.classList.remove('rolling'); diceEl.textContent = String(sum); if(cb) cb(); }, 900);
}
function animateDiceLocal(sum){
  // visual on player devices: try to find diceEl (maybe hidden); if not, show a quick modal
  const d = diceEl;
  if(d){
    d.classList.add('rolling');
    setTimeout(()=> { d.classList.remove('rolling'); d.textContent = String(sum); setTimeout(()=> d.textContent = '—', 1200); }, 900);
  } else {
    // fallback: show quick modal
    const m = el('div'); m.innerHTML = `<h3>Dice</h3><div style="font-size:48px;margin-top:8px">${sum}</div>`; openModal(m); setTimeout(()=> closeModal(), 1000);
  }
}

/* ---------- Start-up & wiring of chooser buttons ---------- */

btnModeCenter.addEventListener('click', ()=> {
  mode = 'center';
  chooser.style.display = 'none';
  mainApp.style.display = 'flex';
  document.getElementById('sideTitle').textContent = 'Center';
  centerUI.style.display = 'block';
  playerUI.style.display = 'none';
  adminUI.style.display = 'none';
  centerCard.style.display = 'flex';
  // generate code & set topic
  const code = randCode();
  centerTopic = PREFIX + code;
  gameCodeEl.textContent = code;
  logCenter('Center started — topic: ' + centerTopic);
  // render board
  renderBoard();
  // ensure center controls hidden by default (board primary)
  setCenterControlsVisible(false);
});

btnModePlayer.addEventListener('click', ()=> {
  mode = 'player';
  chooser.style.display = 'none';
  mainApp.style.display = 'flex';
  document.getElementById('sideTitle').textContent = 'Player';
  centerUI.style.display = 'none';
  playerUI.style.display = 'block';
  adminUI.style.display = 'none';
  // hide board for player device
  boardOuter.style.display = 'none';
});

/* ---------- Center: Start Game & Roll UI ---------- */

startGameBtn.addEventListener('click', ()=> {
  if(!centerTopic) return alert('Start listening and create topic first');
  if(centerPlayers.length === 0){ alert('No players joined'); return; }
  joinsLocked = true;
  setCenterControlsVisible(false);
  logCenter('Game started — joins locked');
  showNotice('Game started — joins locked', 4000);
  publishTopic(centerTopic, { type:'gameStarted', timestamp: Date.now(), centerPlayers }).catch(()=>{});
});

centerRollBtn.addEventListener('click', ()=> {
  if(centerPlayers.length === 0) return alert('No players');
  const p = centerPlayers[currentTurn];
  const r1 = 1 + Math.floor(Math.random()*6), r2 = 1 + Math.floor(Math.random()*6);
  animateDice(r1 + r2, ()=> {
    p.position = (p.position + r1 + r2) % 40;
    logCenter(`(Center) ${p.name} rolled ${r1} & ${r2}`);
    showNotice(`${p.name} rolled ${r1} & ${r2}`, 5000);
    publishTopic(centerTopic, { type:'rolled', assignedId:p.assignedId, r1, r2 }).catch(()=>{});
    publishTopic(centerTopic, { type:'moved', assignedId:p.assignedId, newPos:p.position }).catch(()=>{});
    updatePlayersList(); updateBoard();
  });
});

/* ---------- Misc helpers ---------- */

function logCenter(msg){
  const el = centerLogDiv;
  const p = document.createElement('div'); p.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`; el.prepend(p);
}
function logPlayer(msg){
  const el = playerLogDiv;
  const p = document.createElement('div'); p.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`; el.prepend(p);
}

/* ---------- Final: ensure initial render so center buttons aren't blocked and UI is clickable ---------- */

renderBoard();
/* ensure modal overlay doesn't block clicks when hidden (pointer-events handled in CSS) */

</script>
</body>
